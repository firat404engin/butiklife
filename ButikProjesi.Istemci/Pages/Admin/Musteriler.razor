@page "/admin/musteriler"
@attribute [Authorize(Roles = "Admin")]
@using MudBlazor
@using ButikProjesi.Shared.Modeller
@inject MusteriYonetimiServisi MusteriYonetimiServisi
@inject NavigationManager NavigationManager

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6 mb-8">
    <MudStack Spacing="4">
        <MudText Typo="Typo.h4" Class="mb-4">Müşteri Yönetimi</MudText>
        
        @if (_isLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="py-16">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                <MudText Typo="Typo.h6" Class="mt-4">Müşteriler yükleniyor...</MudText>
            </MudStack>
        }
        else if (!_musteriler.Any())
        {
            <MudStack AlignItems="AlignItems.Center" Spacing="4" Class="py-16">
                <MudIcon Icon="@Icons.Material.Outlined.People" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.h6" Color="Color.Secondary">Henüz müşteri bulunmuyor</MudText>
            </MudStack>
        }
        else
        {
            <MudPaper Elevation="2" Class="pa-4">
                <MudTable Items="_musteriler" Hover="true" Striped="true" Dense="true">
                    <HeaderContent>
                        <MudTh>Kullanıcı ID</MudTh>
                        <MudTh>Email</MudTh>
                        <MudTh>Ad Soyad</MudTh>
                        <MudTh>Toplam Sipariş</MudTh>
                        <MudTh>Kayıt Tarihi</MudTh>
                        <MudTh>İşlemler</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.Id</MudTd>
                        <MudTd>@context.Email</MudTd>
                        <MudTd>@context.AdSoyad</MudTd>
                        <MudTd>
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small">
                                @context.SiparisAdeti sipariş
                            </MudChip>
                        </MudTd>
                        <MudTd>@context.KayitTarihi.ToString("dd.MM.yyyy")</MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                          Color="Color.Primary" 
                                          Size="Size.Small"
                                          OnClick="@(() => NavigationManager.NavigateTo($"/admin/musteri-detay/{context.Id}"))"
                                          Title="Müşteri Detayları" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        }
    </MudStack>
</MudContainer>

@code {
    private List<MusteriDto> _musteriler = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await MusterileriYukle();
    }

    private async Task MusterileriYukle()
    {
        _isLoading = true;
        try
        {
            _musteriler = await MusteriYonetimiServisi.MusterileriGetirAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Müşteriler yüklenirken hata: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }
}
